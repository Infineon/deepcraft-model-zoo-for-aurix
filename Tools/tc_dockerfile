# Copyright (c) 2025, Infineon Technologies AG, or an affiliate of Infineon Technologies AG. All rights reserved.
#
# This software, associated documentation and materials ("Software") is owned by Infineon Technologies AG or one of
# its affiliates ("Infineon") and is protected by and subject to worldwide patent protection, worldwide copyright laws,
# and international treaty provisions. Therefore, you may use this Software only as provided in the license agreement
# accompanying the software package from which you obtained this Software. If no license agreement applies, then any use,
# reproduction, modification, translation, or compilation of this Software is prohibited without the express written
# permission of Infineon.
#
# Disclaimer: UNLESS OTHERWISE EXPRESSLY AGREED WITH INFINEON, THIS SOFTWARE IS PROVIDED AS-IS, WITH NO WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, ALL WARRANTIES OF NON-INFRINGEMENT OF THIRD-PARTY RIGHTS AND IMPLIED
# WARRANTIES SUCH AS WARRANTIES OF FITNESS FOR A SPECIFIC USE/PURPOSE OR MERCHANTABILITY. Infineon reserves the right to make
# changes to the Software without notice. You are responsible for properly designing, programming, and testing the
# functionality and safety of your intended application of the Software, as well as complying with any legal requirements
# related to its use. Infineon does not guarantee that the Software will be free from intrusion, data theft or loss, or other
# breaches ("Security Breaches"), and Infineon shall have no liability arising out of any Security Breaches. Unless otherwise
# explicitly approved by Infineon, the Software may not be used in any application where a failure of the Product or any
# consequences of the use thereof can reasonably be expected to result in personal injury.



# syntax=docker/dockerfile:1.2

# Stage 1: QEMU Builder - Build QEMU TriCore emulator from source
FROM ubuntu:22.04 AS qemu-builder
ARG DEBIAN_FRONTEND=noninteractive
USER root

# Install QEMU build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    git build-essential \
    libglib2.0-dev libfdt-dev libpixman-1-dev \
    zlib1g-dev ninja-build meson \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Copy and execute QEMU build script
COPY Tools/qemu_build.sh /tmp/qemu_build.sh
RUN chmod +x /tmp/qemu_build.sh && /tmp/qemu_build.sh

# Stage 2: Final Runtime Image
FROM ubuntu:22.04
ARG DEBIAN_FRONTEND=noninteractive
USER root

# Runtime dependencies + Jupyter
RUN apt-get update && apt-get install -y --no-install-recommends \
    unzip python3 python3-venv python3-pip \
    libprotobuf-dev protobuf-compiler \
    libglib2.0-dev libfdt-dev libpixman-1-0 libpixman-1-dev \
    zlib1g-dev libepoxy0 libnuma1 libasound2 libpulse0 \
    libncursesw5 libncurses5 \
    libboost-stacktrace1.74.0 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Create user and workspace
RUN useradd -m -s /bin/bash ubuntu
USER ubuntu
WORKDIR /home/ubuntu
RUN mkdir -p out workspace

# Copy QEMU binary from builder stage
COPY --from=qemu-builder --chown=ubuntu:ubuntu /tmp/qemu_6250_tricore/build/qemu-system-tricore /home/ubuntu/qemu-system-tricore

# Copy and setup other tools - combine operations to reduce layers
COPY --chown=ubuntu:ubuntu Tools/onnx2c-accelerated/V1.0.3/onnx2c_model_zoo \
                          Tools/onnx2c-accelerated/V1.0.3/testgen_target_tc4x_model_zoo \
                          Tools/onnx2c-accelerated/V1.0.3/testgen_target_tc3x_model_zoo \
                          /home/ubuntu/
RUN chmod +x /home/ubuntu/onnx2c_model_zoo /home/ubuntu/testgen_target_* /home/ubuntu/qemu-system-tricore

# Setup GCC toolchain with proper permissions and PATH - conservative cleanup
COPY --chown=ubuntu:ubuntu Tools/tricore-gcc/AURIX-GCC-Linux.tar.gz /home/ubuntu/
RUN mkdir tricore_gcc && \
    tar -xzf AURIX-GCC-Linux.tar.gz -C tricore_gcc && \
    rm AURIX-GCC-Linux.tar.gz && \
    chmod -R +x /home/ubuntu/tricore_gcc/bin/ && \
    chmod -R +x /home/ubuntu/tricore_gcc/libexec/

# Add GCC toolchain to PATH
ENV PATH="/home/ubuntu/tricore_gcc/bin:$PATH"

# Setup compilation environment
RUN mkdir -p /home/ubuntu/TC_compilation
COPY --chown=ubuntu:ubuntu Tools/linker_scripts/tsim-lto.ld \
                          Tools/linker_scripts/crttsim.o \
                          /home/ubuntu/TC_compilation/

# Copy tool licenses
COPY --chown=ubuntu:ubuntu LICENSES /home/ubuntu/LICENSES

# Python environment with Jupyter - properly configure venv and cleanup
RUN python3 -m venv venv
ENV PATH="/home/ubuntu/venv/bin:$PATH"
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir flask requests jupyter notebook ipywidgets && \
    # Clean up Python environment to reduce size
    pip cache purge && \
    find /home/ubuntu/venv -name "*.pyc" -delete && \
    find /home/ubuntu/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true && \
    find /home/ubuntu/venv -name "*.pyo" -delete && \
    # Remove unnecessary pip components after installation
    find /home/ubuntu/venv/lib -name "pip" -type d -exec rm -rf {} + 2>/dev/null || true

# Copy application files and source info
COPY --chown=ubuntu:ubuntu Tools/python/onnx2c_flask_server.py \
                          Tools/python/model_converter.py \
                          Tools/python/config.py \
                          Tools/python/debug_conversion.ipynb \
                          /home/ubuntu/
COPY --chown=ubuntu:ubuntu source.txt /home/ubuntu/

# Copy and setup entrypoint
COPY --chown=ubuntu:ubuntu Tools/entrypoint.sh /home/ubuntu/
RUN chmod +x /home/ubuntu/entrypoint.sh

ENV MODE=api
EXPOSE 8080 8888

ENTRYPOINT ["/home/ubuntu/entrypoint.sh"]